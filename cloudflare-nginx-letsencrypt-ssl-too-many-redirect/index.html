<!doctype html><html>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge"><title>Cloudflare, Nginx, Letsencrypt SSL setup. Too many redirect issue. Took three hours to solve. (Silly mistake) - Yet another software engineer</title><link rel=icon type=image/png href=icons/myicon.png><meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:title" content="Cloudflare, Nginx, Letsencrypt SSL setup. Too many redirect issue. Took three hours to solve. (Silly mistake)">
<meta property="og:description" content="A very little knowledge about Cloudflare's SSL feature caused too many redirect issue and took three hours to find and fix.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://shihabmridha.github.io/cloudflare-nginx-letsencrypt-ssl-too-many-redirect/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2019-10-31T10:39:19+00:00">
<meta property="article:modified_time" content="2019-10-31T10:39:19+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Cloudflare, Nginx, Letsencrypt SSL setup. Too many redirect issue. Took three hours to solve. (Silly mistake)">
<meta name=twitter:description content="A very little knowledge about Cloudflare's SSL feature caused too many redirect issue and took three hours to find and fix.">
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel=stylesheet>
<link rel=stylesheet type=text/css media=screen href=https://shihabmridha.github.io/css/normalize.css>
<link rel=stylesheet type=text/css media=screen href=https://shihabmridha.github.io/css/main.css>
<link rel=stylesheet type=text/css href=https://shihabmridha.github.io/css/custom.css>
<link rel=stylesheet type=text/css href=https://shihabmridha.github.io/css/dark.css media="(prefers-color-scheme: dark)">
<script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script>
<script src=https://shihabmridha.github.io/js/main.js></script>
</head>
<body>
<div class="container wrapper post">
<div class=header>
<base href=https://shihabmridha.github.io/>
<h1 class=site-title><a href=https://shihabmridha.github.io/>Yet another software engineer</a></h1>
<div class=site-description><h2>My thoughts are my own</h2><nav class="nav social">
<ul class=flat><a href=https://github.com/shihabmridha title=Github><i data-feather=github></i></a><a href=https://twitter.com/shihabmridha title=Twitter><i data-feather=twitter></i></a></ul>
</nav>
</div>
<nav class=nav>
<ul class=flat>
<li>
<a href=/>Home</a>
</li>
<li>
<a href=/posts>All posts</a>
</li>
<li>
<a href=/about>About</a>
</li>
<li>
<a href=/tags>Tags</a>
</li>
</ul>
</nav>
</div>
<div class=post-header>
<h1 class=title>Cloudflare, Nginx, Letsencrypt SSL setup. Too many redirect issue. Took three hours to solve. (Silly mistake)</h1>
<div class=meta>Posted at &mdash; Oct 31, 2019</div>
</div>
<div class=markdown>
<p>I know you are familiar with Cloudflare, Nginx, and Letsencrypt. In case you didn&rsquo;t know, <strong>Cloudflare</strong> does a lot of things including DNS management, DDoS protection, free SSL, caching and a lot more. <strong>Nginx</strong> is one of the most popular HTTP server / reverse proxy/load balancer and <strong>Letsencrypt</strong> let you install SSL in your server.</p>
<p>I am a fan of all these three technologies. I use Cloudflare a lot because why not? It is giving me protection from DDoS, free SSL, etc for free. When I was planing for creating this blog, the first cms came to my mind is WordPress. It&rsquo;s free, easy to maintain, tons of plugins to do stuff and cheap. But, WordPress was not the only cms that were in my mind. I already know about Ghost and I have a very soft corner for it since it is written in NodeJS. NodeJS and Nginx scales and performs better than WordPress and Apache. I could use Nginx with WordPress but ehh. Finally, I decided to use Ghost.</p>
<p>Bought this domain, set Cloudflare&rsquo;s DNS, created an EC2 Ubuntu 18.04 instance, installed all the necessary stuff and then followed Ghost&rsquo;s official installation instruction. I skipped the SSL part because I decided to use Cloudflare&rsquo;s SSL although I know very little about Cloudflare&rsquo;s SSL feature. All I knew was I enable it from Cloudflare&rsquo;s dashboard and I am good to go. In reality, it was that easy as well. But, I was facing a problem with Ghost. When I tried to add an item to the navigation menu, Ghost forcefully changing the URL from HTTPS to HTTP. I get it. Ghost doesn&rsquo;t know that I am using HTTPS. So, I decided to switch off Cloudflare&rsquo;s SSL and install SSL on my server. This is where I messed things up. <strong>I should not have switched off Cloudflare&rsquo;s SSL.</strong> There were a couple of options: <strong><em>Off, Flexible, Full, Full (Strict).</em></strong> Go to their website to know more about these options. Initially, I was using <strong>Flexible</strong> then switched to <strong>Off</strong>.</p>
<p>Ghost provides handy CLI to install SSL and it uses Letsencrypt. Since I was using Cloudflare&rsquo;s DNS, when I hit my website using HTTPS it goes to Cloudflare and Cloudflare redirect it to HTTP since I switched SSL off. Cloudflare redirects to my server using HTTP but my Nginx config redirects every request to HTTPS. It was creating a redirection cycle like the following steps.</p>
<ol>
<li>Browser (Input HTTPS url to address bar).</li>
<li>Cloudflare DNS resolver. Cloudflare redirects to HTTP (Since SSL is off!).</li>
<li>My Server. My server redirect to HTTPS</li>
<li>Step 2 again.</li>
</ol>
<p>I was like what the hell. What is happening? I kept modifying my Nginx configuration in many ways but could not make it work. Searched for the issue. I have found a lot of answers but honestly, I didn&rsquo;t realize that they are the same victim as mine. I thought mine was different.</p>
<p>After wasting two to three hours I have found a command to trace my request. Then I have found the cycle between my server and Cloudflare. I went to Cloudflare&rsquo;s dashboard and found my fault. Changed my SSL configuration from <strong>Off</strong> to <strong>Full.</strong> Then, it started to work as expected.</p>
<p>I never wasted that much time setting up an SSL certificate, EVER!</p>
<blockquote>
<p>Little knowledge is a dangerous thing.</p>
</blockquote>
</div>
<div class=post-tags>
<nav class="nav tags">
<ul class=flat>
<li><a href=/tags/nginx>Nginx</a></li>
<li><a href=/tags/cloudflare>Cloudflare</a></li>
<li><a href=/tags/letsencrypt>Letsencrypt</a></li>
</ul>
</nav>
</div>
</div>
<div class="footer wrapper">
<nav class=nav>
<div> Â© Another Dev | <a href=https://github.com/vividvilla/ezhil>Ezhil theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div>
</nav>
</div>
<script>feather.replace()</script>
</body>
</html>